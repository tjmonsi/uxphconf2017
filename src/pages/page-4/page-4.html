<!-- Polymer dependencies -->
<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/polymerfire/firebase-auth.html">
<link rel="import" href="../../../bower_components/polymerfire/firebase-document.html">
<link rel="import" href="../../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../../bower_components/reach-core/reach-core-behavior/reach-core-util-behavior.html">
<link rel="import" href="../../../bower_components/iron-image/iron-image.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../bower_components/paper-tooltip/paper-tooltip.html">

<link rel="import" href="../../uxph-conference-2017-icons/uxph-icons.html">

<!-- Style dependency -->
<link rel="import" href="page-4-style.html">

<dom-module id="page-4">
  <template>
    <style is="custom-style" include="page-4-style iron-flex iron-flex-alignment iron-flex-factors">
      :host {
        display: block;
      }
    </style>
    
    <firebase-auth id="gauth" user="{{user}}" provider="google" on-error="handleError"></firebase-auth>
    
    <template is="dom-if" if="{[user}}">
      <firebase-document
          path="/contact/{{user.uid}}"
          data="{{data}}"></firebase-document>
    </template>
    
    <div class="container">
      <iron-image class="blur-background-area" src="/images/assets/city-tiny.jpg" preload fade sizing="cover"></iron-image>
      <iron-image class="background-area" src="/images/assets/city.jpg" preload fade sizing="cover"></iron-image>
      <div class="dark-area"></div>
      <!--<iron-image class="foreground-area" src="/images/assets/uxph.png" preload fade sizing="contain"></iron-image>-->
      
      <div class="content-container vertical layout">
        <div class="flex"></div>
        <div class="horizontal layout wrap">
          <div class="flex"></div>
          <div class="content">
            
            <!-- COPY QUESTION 4 HERE -->
            <p class="question">
              Thanks for answering our survey. <br/>
              If you want to know more about it, Please
              leave your contact information for us to notify you with updates.<br/>
              (Don't worry, we will keep it private)<br/>
              Also leave any comments or suggestions you want us to hear.
            </p>
            
            <!-- COPY ANSWER 2 HERE -->
            <div class="answer-container">
              <paper-input id="name" label="Name" value="{{data.fullname}}"></paper-input>
              <paper-input id="email" label="Email" value="{{data.email}}" type="email"></paper-input>
              <paper-textarea id="comments" label="Comments/Suggestion" value="{{data.comments}}"></paper-textarea>  
            </div>

            <div class="anchor-top horizontal layout">
              <div class="flex"></div>
              <a href="/page-3" class="anchor">
                <paper-button>Back</paper-button>
              </a>  

              <paper-button on-tap="save">Submit</paper-button>

              <div class="flex"></div>
            </div>

          </div>
          <div class="flex"></div>
        </div>
        <div class="flex"></div>
      </div>
      
      <div class="attribution">
        <a href="https://www.flickr.com/photos/bensonkua/6326977875" target="_blank">
          By Benson Kua - Night View of Manila
        </a>
      </div>
      <div class="bug-report">
        <a href="https://github.com/tjmonsi/uxphconf2017/issues" target="_blank" id="bug-report-anchor">
          <paper-icon-button icon="uxph:bug-report"></paper-icon-button>
        </a>
        <paper-tooltip for="bug-report-anchor" position="left">Submit Bug</paper-tooltip>
      </div>
    </div>

    <paper-toast id="toaster"></paper-toast>
  </template>

  <script>
    /* global Polymer */
    /* global firebase */
    
    Polymer({
      is: 'page-4',
      
      properties: {
        user: {
          type: Object,
          notify: true
        },
        data: {
          type: Object
        }
      },
      
      behaviors: [
        Polymer.ReachCoreUtilBehavior  
      ],
      
      observers: [
        '_resize(data.comments)'
      ],
      
      _showNextPage: false,
      
      attached: function() {
        this._showNextPage = false;
        this.$$('.container').style.height = '640px';
        this._resize();
        window.addEventListener('resize', this._resize.bind(this));
      },
      
       detached: function() {
        window.removeEventListener('resize', this._resize.bind(this));
      },
      
      _resize: function() {
        
        var height = this.windowSize().height;
        Polymer.dom.flush();
        var contentHeight = this.$$('.content').getBoundingClientRect().height;
        contentHeight = contentHeight ? contentHeight : 600;
        this.$$('.container').style.height = height < contentHeight ? (contentHeight + 40) + 'px' : height + 'px';
      },
      
      ready: function() {
        this.autoLogin();
      },
      
      autoLogin: function() {
        this.$.gauth.signInAnonymously().then((user) => {
          this.user = user;
        }).catch((error) => {
          this.async(() => {
            this.$.toaster.show({text: error.message, duration: 10000});
          }, 6000);
        });
      },
      
      handleError: function(error) {
        this.$.toaster.show({text: error.message, duration: 10000});
      },
      
      save: function() {
        this.$.toaster.show('Saving');
        this.$.gauth.signOut().then(() => {
          this.$.toaster.show('Saved');
          window.location.href = '/page-5'
        });
      }
      
      
    });
  </script>
</dom-module>
