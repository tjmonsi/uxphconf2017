<!-- Polymer dependencies -->
<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/polymerfire/firebase-auth.html">
<link rel="import" href="../../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../../bower_components/reach-core/reach-core-behavior/reach-core-util-behavior.html">
<link rel="import" href="../../../bower_components/iron-image/iron-image.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../../bower_components/paper-radio-button/paper-radio-button.html">
<link rel="import" href="../../../bower_components/paper-radio-group/paper-radio-group.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../bower_components/paper-tooltip/paper-tooltip.html">

<link rel="import" href="../../uxph-conference-2017-icons/uxph-icons.html">

<!-- Style dependency -->
<link rel="import" href="web-home-style.html">

<dom-module id="web-home">
  <template>
    <style is="custom-style" include="web-home-style iron-flex iron-flex-alignment iron-flex-factors">
      :host {
        display: block;
      }
    </style>
    
    <firebase-auth id="gauth" user="{{user}}" provider="google" on-error="handleError"></firebase-auth>
    <div class="container">
      <iron-image class="blur-background-area" src="/images/assets/baywalk-tiny.jpg" preload fade sizing="cover"></iron-image>
      <iron-image class="background-area" src="/images/assets/baywalk.jpg" preload fade sizing="cover"></iron-image>
      <div class="dark-area"></div>
      <iron-image class="foreground-area" src="/images/assets/uxph.png" preload fade sizing="contain"></iron-image>
      
      <div class="content-container vertical layout">
        <div class="flex"></div>
        <div class="horizontal layout wrap">
          <div class="flex"></div>
          <div class="content">
            
            <!-- COPY QUESTION 1 HERE -->
            <p class="question">
              If there were a User Experience Conference in the Philippines inviting 
              international speakers and groundbreaking workshops, would you attend?
            </p>
            
            <!-- COPY ANSWER 1 HERE -->
            <paper-radio-group id="q1" class="answer" selected="{{q1}}">
              <paper-radio-button name="participant">Yes, Iâ€™d like to participate</paper-radio-button>
              <paper-radio-button name="sponsor">Yes, and I'd like to sponsor</paper-radio-button>
              <paper-radio-button name="nope">No, I think it is not needed</paper-radio-button>
            </paper-radio-group>
            
            <template is="dom-if" if="{{_showNextPage}}">
              <div class="anchor-top">
                <a href="/page-2" class="anchor">
                  <paper-button>Next</paper-button>
                </a>  
              </div>
              
            </template>
            <template is="dom-if" if="{{!_showNextPage}}">
              <div class="placeholder">
              </div>  
            </template>
          </div>
          <div class="flex"></div>
        </div>
        <div class="flex"></div>
      </div>
      
      <div class="attribution">
        <a href="https://www.flickr.com/photos/titaix/16005387277/in/photostream/" target="_blank">
          By Yujin - Baywalk Sunset - Flickr
        </a>
      </div>
      <div class="bug-report">
        <a href="https://github.com/tjmonsi/uxphconf2017/issues" target="_blank" id="bug-report-anchor">
          <paper-icon-button icon="uxph:bug-report"></paper-icon-button>
        </a>
        <paper-tooltip for="bug-report-anchor" position="left">Submit Bug</paper-tooltip>
      </div>
    </div>

    <paper-toast id="toaster"></paper-toast>
  </template>

  <script>
    /* global Polymer */
    /* global firebase */
    
    Polymer({
      is: 'web-home',
      
      properties: {
        user: {
          type: Object,
          notify: true
        },
        q1: {
          type: String,
          observer: '_q1Changed'
        }
      },
      
      behaviors: [
        Polymer.ReachCoreUtilBehavior  
      ],
      
      _showNextPage: false,
      
      attached: function() {
        this._showNextPage = false;
        this._resize();
        window.addEventListener('resize', this._resize.bind(this));
      },
      
       detached: function() {
        window.removeEventListener('resize', this._resize.bind(this));
      },
      
      _resize: function() {
        var height = this.windowSize().height;
        Polymer.dom.flush();
        var contentHeight = this.$$('.content').getBoundingClientRect().height;
        contentHeight = contentHeight ? contentHeight : 600;
        this.$$('.container').style.height = height < contentHeight ? (contentHeight + 40) + 'px' : height + 'px';
      },
      
      ready: function() {
        this.autoLogin();
      },
      
      autoLogin: function() {
        this.$.gauth.signInAnonymously().then((user) => {
          this.user = user;
        }).catch((error) => {
          this.async(() => {
            this.$.toaster.show({text: error.message, duration: 10000});
          }, 6000)
        });
      },
      
      handleError: function(error) {
        this.$.toaster.show({text: error.message, duration: 10000});
      },
      
      _q1Changed: function(e) {
        // console.log(this.user, firebase)
        this.$.toaster.show('Submitting your answer');
        if (firebase && this.user) {
          firebase.database().ref('users/' + this.user.uid + '/q1').set(e).then(() => {
            this._showNextPage = true;
            this.async(() => {
              this.$$('.anchor-top').style.opacity = 1;
            }, 100);
          }).catch((error) => {
            this.$.toaster.show({text: error.message, duration: 10000});
          });
        } else if (!this.user) {
          this.$.toaster.show({text: 'Can\'t save answer for now.', duration: 10000});
        } else {
          this.$.toaster.show({text: 'Can\'t save answer for now. Please refresh and try again', duration: 10000});
        }
      }
    });
  </script>
</dom-module>
