<!-- Polymer dependencies -->
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/polymerfire/firebase-auth.html">
<link rel="import" href="../../bower_components/polymerfire/firebase-document.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">

<!-- Style dependency -->
<link rel="import" href="support-page-style.html">

<dom-module id="support-page">
  <template>
    <style is="custom-style" include="support-page-style iron-flex iron-flex-alignment iron-flex-factors" >
      :host {
        display: block;
      }
    </style>

    <iron-ajax
      auto
      url="https://jsonip.com/"
      handle-as="json"
      on-response="_handleIPResponse"
      debounce-duration="300"></iron-ajax>

    <firebase-auth id="gauth" user="{{user}}" provider="google" on-error="handleError"></firebase-auth>

    <template is="dom-if" if="[[user]]">
      <firebase-document
          path="/contactInfo/{{user.uid}}"
          data="{{contact}}"></firebase-document>
    </template>
    
    <div class="horizontal layout wrap">
      <div class="flex-3 main-content">

        <a href="/">
          <img src="/images/assets/logo.png" class="logo">
        </a>

        <p class="text-content support-header">
          Please enter your details so we can process:
        </p>
        
        <p class="text-content">
          Reward:<br/>
          <b>[[_getReward(params.id, user)]]</b>
        </p>
        
        <p class="text-content">
          <paper-input label="First Name" value="{{contact.firstName}}"></paper-input>
          <paper-input label="Last Name" value="{{contact.lastName}}"></paper-input>
          <paper-input label="Email" value="{{contact.email}}" type="email" error-message="Please input a valid email"></paper-input>
          <paper-input label="Contact Number" value="{{contact.contactNumber}}" auto-validate pattern="(\d|-|\+|\(|\)|\s)+" error-message="Please input a valid number"></paper-input>
        </p>
        
        <p class="text-content indent">
          (We will keep your emails/phone numbers confidential and promise not to spam you or sell/share to any other party.)
        </p>
        
        <p class="text-content">
          Before we proceed, we would like to find out your venue preference. Which is a more favorable venue for you?
        </p>
        
        <div class="venue-list">
          
          <template is="dom-repeat" items="[[venues]]">
            <div class="venue-item horizontal layout">
              <div class="venue-checkbox">
                <paper-checkbox
                    class="contact-info-place"
                    value="[[item.$key]]" 
                    checked="[[_contactInfoPlaceCheck(item.$key, contact.place)]]" 
                    on-tap="_contactInfoPlaceTapped"></paper-checkbox>
              </div>

              <div class="venue-content" value$="[[item.$key]]" on-tap="_contactInfoPlaceTapped">
                <h3>[[item.name]]</h3>
                <p class="venue-body">
                  [[item.description]]
                </p>  
              </div>
            </div>
          </template>
        </div>

        <div class="submit-area">
          <a href="/thanks" on-tap="logout">
            <paper-button raised>
              Submit
            </paper-button>
          </a>
          
        </div>
      </div>

      <!-- FLEX SPACER -->
      <div class="flex spacer"></div>

      <!-- SIDE WINDOW -->
      <paper-material class="flex-2 side-window">
        <div class="side-window-title">
          <h2>Support us</h2>
          <h4>Rewards</h4>
        </div>
        <template is="dom-repeat" items="[[pledges]]">
          <template is="dom-if" if="[[_checkPledge(params.id, item.$key)]]">          
            <paper-material class="pledge-item pledge-picked">              
              <p class="pledge-description">
                <b class="pledge-title">[[item.title]]</b><br/>
                [[item.description]]
              </p>
            </paper-material>            
          </template>         
        </template>
      </div>
    </div>

    <paper-toast id="toaster"></paper-toast>

  </template>

  <script>
    Polymer({
      is: 'support-page',
      properties: {
        ipAddress: {
          type: String,
          observer: '_ipAddressChanged'
        },
        user: {
          type: Object,
          value: null,
          notify: true
        },
        contact: {
          type: Object
        },
        venues: {
          type: Array,
          value: function() {
            return [
              {
                $key: 'Manila',
                name: 'Metro Manila, Philippines',
                description: 'We will find you a nice venue at the heart of the city where it’s easy to shop and accessible to major metropolitan business districts. Might be bad traffic on certain times of the day.'
              },
              {
                $key: 'Cebu',
                name: 'Mactan, Cebu, Philippines',
                description: 'Conference and vacation. Experience the beaches in the Philippines. Near an international airport and easily accessible to the sea and waves. If you’re based in Manila, this might involve getting an early plane ticket.'
              }
            ]
          }
        },
        pledges: {
          type: Array,
          value: function() {
            return [
              {
                $key: '0',
                title: 'GET A Conf Sticker',
                description: 'Pledge P50 and get your own UXPH Sticker',
                reward: 'Conference Sticker'
              },
              {
                $key: '1',
                title: 'GET A Conf PIN',
                description: 'Pledge P150 and get your own UXPH Pin',
                reward: 'UXPH Pin'
              },
              {
                $key: '2',
                title: 'GET A Conf T-SHIRT',
                description: 'Pledge P500 and get your own UXPH Shirt',
                reward: 'UXPH Shirt'
              },
              {
                $key: '3',
                title: 'GET 1 Conf Early bird Ticket',
                description: 'Tickets will cost P4000. Pledge P2500 now  and get an early ticket',
                reward: 'Conference Early Bird Ticket'
              },
              {
                $key: '4',
                title: 'GET 2 Conf Early bird Ticket',
                description: 'Pledge P4000 and get 2 tickets (instead of paying for P5000)',
                reward: 'Two (2) Conference Early Bird Tickets'
              }
            ]
          }
        }
      },

      attached: function() {
        window.scrollTo(0, 0)
        this.autoLogin();
      },
      
      autoLogin: function() {
        this.async(() => {
          if (!this.user) {
            this.$.gauth.signInAnonymously().then((user) => {
              this.user = user;
              return firebase.database().ref(`/contactInfo/${this.user.uid}`).transaction((val) => {
                if (!val) {
                  return {};
                }
              })
            }).catch((error) => {
              console.log(error)
              this.async(() => {
                this.handleError(error);
              }, 6000);
            });
          }
        }, 2000);
      },

      logout: function() {
        this.$.gauth.signOut().catch((error) => {
          this.async(() => {
            this.handleError(error);
          }, 6000);
        });
      },

      handleError: function(error) {
        console.log(this.user)
        console.error(error);
        var err = error.detail ? error.detail : error
        err = error.message ? error.message : err;
        
        this.$.toaster.show({text: err, duration: 10000});
      },
      
      _checkPledge: function(i, j) {
        return i === j;
      },

      _getReward: function(i) {
        if (this.user) {
          firebase.database().ref(`/contactInfo/${this.user.uid}/pledge`).set({
            title: this.pledges[i].title,
            reward: this.pledges[i].reward
          });
        }
        return this.pledges[i].reward
      },

      _contactInfoPlaceCheck: function(key, place) {        
        return key === place;
      },

      _contactInfoPlaceTapped: function(e) {
        var place = e.target.checked && e.target.value;
        place = place ? place : e.target.parentNode.getAttribute('value');
        place = place ? place : e.target.getAttribute('value');
        place = place ? place : 'Manila';
        firebase.database().ref(`/contactInfo/${this.user.uid}/place`).set(place)
      },

      _handleIPResponse: function(e) {
        var data = e.detail.response;
        this.ipAddress = data.ip;        
      },

      _ipAddressChanged: function(ip) {
        if (this.user) {
          firebase.database().ref(`/contactInfo/${this.user.uid}/ipAddress`).set(ip);
        }
      }
    });
  </script>
</dom-module>
